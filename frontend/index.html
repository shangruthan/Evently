<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evently Admin</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f4f4f9; color: #333; }
        h1, h2, h3 { color: #5a2a88; }
        .container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        form { display: flex; flex-direction: column; gap: 0.5rem; }
        input { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        button { padding: 0.7rem; background-color: #7e42b3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background-color: #5a2a88; }
        hr { border: 0; border-top: 1px solid #eee; margin: 1.5rem 0; }
        #events-list { list-style: none; padding: 0; }
        #events-list li { background: #fafafa; border: 1px solid #eee; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .booking-form { display: flex; gap: 0.5rem; align-items: center; }
        .booking-form input { width: 50px; }
        #status { padding: 1rem; border-radius: 4px; margin-top: 1rem; text-align: center; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-info { background-color: #cce5ff; color: #004085; }
    </style>
</head>
<body>

    <h1>Welcome to Evently</h1>

    <div id="auth-section" class="container">
        <h2>Register / Login</h2>
        <div id="register-form-container">
            <h3>Register</h3>
            <form id="register-form">
                <input type="text" id="register-name" placeholder="Name" required>
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
            </form>
        </div>
        <hr>
        <div id="login-form-container">
            <h3>Login</h3>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
        </div>
    </div>
    
    <div id="user-section" class="container" style="display: none;">
        <h2 id="welcome-message"></h2>
        <button id="logout-button">Logout</button>
    </div>
    
    <div id="admin-panel" class="container" style="display: none;">
        <h2>Admin Panel</h2>
        <form id="create-event-form">
            <h3>Create a New Event</h3>
            <input type="text" id="event-name" placeholder="Event Name" required>
            <input type="text" id="event-venue" placeholder="Venue" required>
            <input type="datetime-local" id="event-start-time" required>
            <input type="number" id="event-capacity" placeholder="Capacity" required min="1">
            <button type="submit">Create Event</button>
        </form>
    </div>

    <div class="container">
        <h2>Upcoming Events in Chennai</h2>
        <ul id="events-list">
            <p>Loading events...</p>
        </ul>
    </div>
    
    <div id="status"></div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let jwtToken = null;
        let userRole = null;

        // --- DOM Elements ---
        const eventsList = document.getElementById('events-list');
        const statusDiv = document.getElementById('status');
        // ... other elements ...
        const registerForm = document.getElementById('register-form');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const createEventForm = document.getElementById('create-event-form');
        const authSection = document.getElementById('auth-section');
        const userSection = document.getElementById('user-section');
        const adminPanel = document.getElementById('admin-panel');
        const welcomeMessage = document.getElementById('welcome-message');


        // --- Helper Functions ---
        function showStatus(message, type = 'success') {
            statusDiv.textContent = message;
            statusDiv.className = `status-${type}`;
            setTimeout(() => statusDiv.textContent = '', 5000);
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }
        
        function updateUIForLogin(email, role) {
            authSection.style.display = 'none';
            userSection.style.display = 'block';
            welcomeMessage.textContent = `Welcome, ${email}!`;
            if (role === 'admin') adminPanel.style.display = 'block';
        }
        
        function updateUIForLogout() {
            authSection.style.display = 'block';
            userSection.style.display = 'none';
            adminPanel.style.display = 'none';
        }

        // --- API Functions ---
        async function fetchEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/events`);
                if (!response.ok) throw new Error('Failed to fetch events');
                const result = await response.json();
                
                eventsList.innerHTML = '';
                if (result.data && result.data.length > 0) {
                    result.data.forEach(event => {
                        const li = document.createElement('li');
                        const eventDate = new Date(event.start_time).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                        li.innerHTML = `
                            <div>
                                <strong>${event.name}</strong><br>
                                <small>${event.venue} on ${eventDate}</small><br>
                                <small>Tickets left: ${event.capacity - event.booked_tickets}</small>
                            </div>
                            <form class="booking-form" data-event-id="${event.id}">
                                <input type="number" class="quantity-input" value="1" min="1" max="${event.capacity - event.booked_tickets}">
                                <button type="submit">Book</button>
                            </form>
                        `;
                        eventsList.appendChild(li);
                    });
                } else {
                    eventsList.innerHTML = '<p>No upcoming events found.</p>';
                }
            } catch (error) {
                showStatus(error.message, 'error');
                eventsList.innerHTML = '<p>Could not load events.</p>';
            }
        }
        
        async function bookEvent(eventId, quantity) {
            if (!jwtToken) {
                showStatus('You must be logged in to book a ticket.', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/events/${eventId}/book`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}` 
                    },
                    body: JSON.stringify({ quantity })
                });
                const result = await response.json();
                
                if (response.status === 202) {
                    showStatus(result.data.status, 'info');
                    return;
                }
                
                if (!response.ok) throw new Error(result.error.message || 'Booking failed');
                showStatus(`Successfully booked ${quantity} ticket(s)!`);
                fetchEvents();
            } catch (error) {
                showStatus(`Booking failed: ${error.message}`, 'error');
            }
        }
        // ... other API functions (createEvent, login, register) are the same ...
        async function createEvent(eventData) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/events`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}` 
                    },
                    body: JSON.stringify(eventData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error.message || 'Event creation failed');
                showStatus('Event created successfully!');
                createEventForm.reset();
                fetchEvents();
            } catch (error) {
                showStatus(`Event creation failed: ${error.message}`, 'error');
            }
        }

        // --- Event Listeners ---
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error.message || 'Registration failed');
                showStatus('Registration successful! You can now log in.');
                registerForm.reset();
            } catch (error) {
                showStatus(`Registration failed: ${error.message}`, 'error');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error.message || 'Login failed');
                jwtToken = result.data.token;
                const decodedToken = parseJwt(jwtToken);
                userRole = decodedToken.role;
                
                showStatus('Login successful!');
                loginForm.reset();
                updateUIForLogin(email, userRole);
            } catch (error) {
                showStatus(`Login failed: ${error.message}`, 'error');
            }
        });
        
        logoutButton.addEventListener('click', () => {
            jwtToken = null;
            userRole = null;
            updateUIForLogout();
            showStatus('You have been logged out.');
        });
        
        eventsList.addEventListener('submit', (e) => {
            if (e.target.classList.contains('booking-form')) {
                e.preventDefault();
                const eventId = e.target.getAttribute('data-event-id');
                const quantity = parseInt(e.target.querySelector('.quantity-input').value);
                bookEvent(eventId, quantity);
            }
        });

        createEventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const eventData = {
                name: document.getElementById('event-name').value,
                venue: document.getElementById('event-venue').value,
                start_time: new Date(document.getElementById('event-start-time').value).toISOString(),
                capacity: parseInt(document.getElementById('event-capacity').value)
            };
            createEvent(eventData);
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', fetchEvents);
    </script>
</body>
</html>